{% extends "base.html" %}

{% block title %}Course Detail â€” TMJ{% endblock %}

{% block content %}

{# Fallbacks so the page still renders if some values are missing #}
{% set course_name = (course.title if course is defined else course_name) or "Intro to Python" %}
{% set status = status or "completed" %}
{% set status_label = status_label or "Completed" %}
{% set progress_percent = progress_percent or 100 %}
{% set completion_date = completion_date or "Nov 26, 2025" %}

<section class="course-page">

  <!-- HEADER: title + status + thumbnail -->
  <header class="course-header">
    <div class="course-header-main">
      <h1 class="course-title">{{ course_name }}</h1>
      <span class="course-status course-status-{{ status }}">
        {{ status_label }}
      </span>
    </div>

    <div class="course-header-media">
      {# Pick a thumbnail based on the course title #}
      {% set thumb = 'img/course-python.png' %}

      {% if course and course.title == 'Study Skills & Habits' %}
        {% set thumb = 'img/course-study-skills.png' %}
      {% elif course and course.title == 'Time Management Essentials' %}
        {% set thumb = 'img/course-time-management.png' %}
      {% elif course and course.title == 'Effective Note-Taking' %}
        {% set thumb = 'img/course-note-taking.png' %}
      {% elif course and course.title == 'Mindfulness for Students' %}
        {% set thumb = 'img/course-mindfulness.png' %}
      {% endif %}

      <img
        src="{{ url_for('static', filename=thumb) }}"
        alt="Course thumbnail for {{ course.title if course else 'course' }}"
        class="course-thumbnail"
      >
    </div>
  </header>

  <!-- OVERALL COURSE PROGRESS BAR -->
  <section class="course-section">
    <h2>Course progress</h2>
    <p>You have completed {{ progress_percent }}% of this course.</p>

    <div class="progress-bar course-progress-bar">
      <div class="progress-fill" style="width: {{ progress_percent }}%;"></div>
    </div>

    <!-- NEW: streak display (UI only) -->
    {% if streak_days %}
      <p class="streak-text">
        ðŸ”¥ Current streak: {{ streak_days }} day{% if streak_days != 1 %}s{% endif %} in a row.
      </p>
    {% endif %}

    <!-- NEW: reminder banner (UI only) -->
    {% if reminder_message %}
      <div class="reminder-banner">
        {{ reminder_message }}
      </div>
    {% endif %}
  </section>

  <!-- MODULE LIST (dynamic data) -->
  {% set modules = modules or [] %}

  <section class="course-section">
    <h2>Modules in this course</h2>

    <ul class="course-module-list">
      {% for m in modules %}
        <li class="course-module-item">
          <div class="course-module-header">
            <span>{{ m.module_name }}</span>
            <span>{{ m.percent_complete }}%</span>
          </div>
          <div class="progress-bar module-progress-bar">
            <div class="progress-fill" style="width: {{ m.percent_complete }}%;"></div>
          </div>
        </li>
      {% endfor %}
    </ul>
  </section>

  <!-- NEW: MODULE NOTES SECTION -->
  <section class="course-section course-section-notes">
    <h2>My notes for this module</h2>

    {% if current_module %}
      <p class="notes-module-label">
        Module: {{ current_module.title }}
      </p>

      <form method="post">
        {{ form.hidden_tag() }}

        <div class="form-group">
          {{ form.content.label(class="form-label") }}
          {{ form.content(
               class="form-input form-textarea",
               rows="4",
               placeholder="Write your thoughts, questions, or reminders hereâ€¦"
          ) }}
        </div>

        <button type="submit" class="btn-primary">
          {{ form.submit.label.text }}
        </button>
      </form>

      {% if module_note and module_note.content %}
        <div class="notes-preview">
          <h3>Last saved note</h3>
          <p>{{ module_note.content }}</p>
        </div>
      {% endif %}
    {% else %}
      <p>No modules found for this course yet, so notes are disabled.</p>
    {% endif %}
  </section>
  <!-- END NOTES SECTION -->

  <!-- COMPLETION BADGE (only when done) -->
  {% if status == "completed" or progress_percent == 100 %}
    <section class="course-section course-section-completed-banner">
      <div class="completed-banner">
        <div class="completed-text">
          <h2>ðŸŽ‰ Course completed!</h2>
          <p>You finished this course on {{ completion_date }}.</p>
        </div>
        <div class="completed-badge">
          <img
            src="{{ url_for('static', filename='img/Completion Badge.png') }}"
            alt="Completion badge"
            class="completion-badge-image"
          >
        </div>
      </div>
    </section>
  {% endif %}

</section>

{% endblock %}
